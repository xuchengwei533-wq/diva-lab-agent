é¡¹ç›®å¯¹é½åˆ°æ–°å‰ç«¯é¡µé¢ï¼šåŠŸèƒ½/æ¥å£/å‡½æ•°è°ƒç”¨æ¸…å•ï¼ˆä»¥ chat_interface.html ä¸ºå‚è€ƒï¼‰

ä¸€ã€ç³»ç»Ÿç”±å“ªäº›æœåŠ¡ç»„æˆï¼ˆç«¯å£ä¸èŒè´£ï¼‰
1) é™æ€é¡µé¢æœåŠ¡å™¨ï¼ˆ8000ï¼‰
   - å…¥å£ï¼šmao_demo_server.py
   - ä½œç”¨ï¼šç”¨ HTTP ç›´æ¥æä¾› mao_demo.htmlã€chat_interface.html ç­‰é™æ€èµ„æº
   - è®¿é—®ï¼š
     - http://localhost:8000/mao_demo.html
     - http://localhost:8000/chat_interface.html

2) å¯¹è¯æœåŠ¡ï¼ˆ8003ï¼‰
   - æ–‡ä»¶ï¼šbackend/qwen_chat_server.py
   - ä½œç”¨ï¼šå°†å‰ç«¯æ¶ˆæ¯è½¬å‘ç»™ DashScope ç™¾ç‚¼æ™ºèƒ½ä½“åº”ç”¨ï¼Œå¹¶ä»¥ SSE æ–¹å¼æµå¼å›ä¼ 
   - æ¥å£ï¼š
     - GET  /health
     - POST /api/chat/stream   ï¼ˆSSEï¼šdata: {"type":"delta","delta":"..."}\n\nï¼‰
     - POST /api/chat          ï¼ˆéæµå¼è°ƒè¯•ï¼‰

3) TTS æœåŠ¡ï¼ˆ8004ï¼ŒWebSocketï¼‰
   - æ–‡ä»¶ï¼šbackend/tts_ws_server.py
   - ä½œç”¨ï¼šå‰ç«¯é€šè¿‡ WS å‘é€â€œè¿½åŠ æ–‡æœ¬/æäº¤â€ï¼Œåç«¯è°ƒç”¨ DashScope TTSï¼Œè¿”å› audio urlï¼ˆæˆ–å¯é€‰ pcm deltaï¼‰
   - æ¥å£ï¼š
     - WS /ws/tts?voice=Cherry&model=qwen3-tts-flash&language_type=Chinese
   - å‰ç«¯ä¾èµ–çš„æ¶ˆæ¯åè®®ï¼š
     - å‘é€ï¼š{"type":"input_text_buffer.append","text":"..."}
     - å‘é€ï¼š{"type":"input_text_buffer.commit"}
     - å‘é€ï¼š{"type":"session.finish"}
     - æ¥æ”¶ï¼š{"type":"session.ready", ...}
     - æ¥æ”¶ï¼š{"type":"response.audio.meta","meta":{"url": "...", "expires_at": ...}}
     - æ¥æ”¶ï¼š{"type":"error","error":"..."}

4) è¯­éŸ³è¯†åˆ« ASRï¼ˆ8006ï¼‰
   - æ–‡ä»¶ï¼šbackend/asr_new.py
   - ä½œç”¨ï¼šæ¥æ”¶å‰ç«¯å½•éŸ³è½¬æˆçš„ PCM16k æ•°æ®ï¼Œå†™ä¸´æ—¶ wavï¼Œè°ƒç”¨ DashScope ASRï¼Œè¿”å›è¯†åˆ«æ–‡æœ¬
   - æ¥å£ï¼š
     - GET  /health
     - POST /api/voice/start
       - è¯·æ±‚ JSONï¼š
         - audio_data: base64(PCM16LE, 16k, mono)
         - audio_format: "pcm16le_16k_mono"
       - å“åº” JSONï¼š
         - success: bool
         - message: string
         - text: string
         - has_result: bool
         - debug: { audio: {duration_sec,rms,peak,zero_frac,...}, asr: {model,code,message,...} }
     - GET  /api/voice/text
     - POST /api/voice/clear

5) éŸ³é¢‘è¯„åˆ†ï¼ˆ8005ï¼‰
   - æ–‡ä»¶ï¼šbackend/asr_server.py
   - ä½œç”¨ï¼šæ¥æ”¶ base64 éŸ³é¢‘ï¼ˆwav/mp3/webm/ogg ç­‰ï¼‰ï¼Œlibrosa è§£ç +æç‰¹å¾ï¼ŒPyTorch æ¨¡å‹è¾“å‡º 10 ç»´è¯„åˆ†
   - æ¥å£ï¼š
     - GET  /health
     - POST /api/audio/score
       - è¯·æ±‚ JSONï¼š
         - audio_data: base64(å®¹å™¨éŸ³é¢‘å­—èŠ‚ï¼›ç”± audio_format æŒ‡ç¤º)
         - audio_format: "wav" | "mp3" | "webm" | "ogg" | ...
         - voice_type: "å¥³é«˜éŸ³ Soprano" | "å¥³ä¸­éŸ³ Mezzo" | "ç”·é«˜éŸ³ Tenor" | "ç”·ä¸­éŸ³ Baritone"
           - ä¹Ÿæ”¯æŒåˆ«åï¼šSoprano/Mezzo/Tenor/Baritoneï¼ˆåç«¯ä¼šæ˜ å°„ï¼‰
       - å“åº” JSONï¼š
         - success: bool
         - message: string
         - overall: floatï¼ˆ10 ç»´å¹³å‡ï¼‰
         - scores: [{technique: string, score: int(1..5)} x10]
         - voice_type: stringï¼ˆè§„èŒƒåŒ–åçš„å£°éƒ¨ï¼‰
         - original_sr: number
         - target_sr: number
         - duration_sec: number
         - rms: number

äºŒã€å¯¹é½åˆ°æ–°å‰ç«¯é¡µé¢ï¼šä½ æœ€å°‘éœ€è¦å®ç°/ä¿ç•™å“ªäº›â€œå‰ç«¯å‡½æ•°â€
è¯´æ˜ï¼šä¸‹é¢æŒ‰â€œèƒ½åŠ›æ¨¡å—â€åˆ†ç»„ã€‚æ–°å‰ç«¯å¦‚æœä¸å¤ç”¨ chat_interface.htmlï¼Œå¯ä»¥æŒ‰åŒåæˆ–åŒèŒè´£å®ç°ã€‚

A. åŸºç¡€é…ç½®ï¼ˆå¿…é¡»ï¼‰
1) HOST / API_BASE / VOICE_API_URL / CHAT_API_URL / TTS_WS_URL
   - å‚è€ƒï¼šchat_interface.html ä¸­çš„å¸¸é‡
   - ç›®çš„ï¼šç»Ÿä¸€ç®¡ç†ç«¯å£ä¸ hostï¼ˆé¿å… localhost/å±€åŸŸç½‘ IP ä¸ä¸€è‡´å¯¼è‡´è¯·æ±‚å‘é”™ï¼‰

B. å¯¹è¯ï¼ˆå¿…é¡»ï¼‰
2) sendMessage()
   - èŒè´£ï¼šæ”¶é›†è¾“å…¥æ¡†æ–‡æœ¬ -> append åˆ° chatHistory -> fetch(`${CHAT_API_URL}/api/chat/stream`) -> è§£æ SSE å¹¶æ›´æ–° UI
   - ä¾èµ–ï¼š
     - extractSseEvents()ï¼šå°† SSE buffer åˆ‡åˆ†æˆ events
     - createStreamingBotMessage()ï¼šåˆ›å»ºç”¨äºæµå¼è¿½åŠ çš„æ¶ˆæ¯ DOM
     - addMessage()ï¼šç”¨æˆ·æ¶ˆæ¯/æœ€ç»ˆæ–‡æœ¬è½åº“

3) extractSseEvents(buffer)
   - èŒè´£ï¼šæŠŠ text/event-stream çš„ data è¡Œè§£ææˆ JSON å­—ç¬¦ä¸²æ•°ç»„

4) addMessage(text, sender)
   - èŒè´£ï¼šæ¸²æŸ“æ¶ˆæ¯ï¼ˆuser/botï¼‰

C. ASR è¯­éŸ³è¾“å…¥è½¬æ–‡å­—ï¼ˆå¿…é¡»ï¼Œè‹¥æ–°å‰ç«¯éœ€è¦â€œè¯­éŸ³è¾“å…¥â€ï¼‰
5) initVoiceRecognition()
   - èŒè´£ï¼šç”³è¯·éº¦å…‹é£æƒé™ã€åˆ›å»º MediaRecorderã€ç»‘å®š ondataavailable/onstop
   - è¾“å‡ºï¼šç”¨æˆ·åœæ­¢å½•éŸ³åï¼Œè½¬æˆ PCM16k å¹¶è°ƒç”¨ sendPcmToServer()

6) toggleRecording()
   - èŒè´£ï¼šæ§åˆ¶å½•éŸ³å¼€å§‹/åœæ­¢ï¼Œæ›´æ–°æŒ‰é’®çŠ¶æ€

7) blobToPcm16kInt16ArrayBuffer(audioBlob)
   - èŒè´£ï¼šWebM/OGG ç­‰å½•éŸ³å®¹å™¨ -> decodeAudioData -> OfflineAudioContext é‡é‡‡æ ·åˆ° 16k -> Float32 -> Int16

8) sendPcmToServer(base64Pcm)
   - èŒè´£ï¼šPOST `${VOICE_API_URL}/api/voice/start`ï¼Œæ‹¿åˆ° text åå†™å…¥è¾“å…¥æ¡†å¹¶è§¦å‘ sendMessage()
   - æ³¨æ„ï¼šè¿™é‡Œå®ç°äº†â€œè¯†åˆ«å®Œè‡ªåŠ¨å‘é€â€

D. è¯„åˆ†ï¼ˆå¯é€‰ï¼šæ–‡ä»¶è¯„åˆ† + å®æ—¶å½•éŸ³è¯„åˆ†ï¼‰
9) startScoring()
   - èŒè´£ï¼šè¯»å–æ–‡ä»¶ inputï¼ŒarrayBuffer->base64ï¼ŒguessAudioFormatFromFile()ï¼Œè°ƒç”¨ sendAudioForScoring()

10) sendAudioForScoring(audioData, voiceType, audioFormat)
   - èŒè´£ï¼šPOST `${API_BASE}/api/audio/score`ï¼Œå¹¶åšé”™è¯¯å¤„ç†

11) displayScoringResults(result)
   - èŒè´£ï¼šæ¸²æŸ“æ€»ä½“åˆ†/10 ç»´åˆ—è¡¨/æŸ±çŠ¶å›¾ï¼Œå¹¶æŠŠè¯„åˆ†æ‘˜è¦è¿½åŠ åˆ°èŠå¤©
   - ä¾èµ–ï¼š
     - drawScoreChart(result)
     - TECH_NAME_MAPï¼ˆåç«¯ technique -> ä¸­æ–‡åæ˜ å°„ï¼‰

12) toggleScoreRecording() / beginScoreRecording() / confirmScoreVoiceAndStart()
   - èŒè´£ï¼šå®ç°â€œğŸ¼ å½•éŸ³å¹¶è¯„åˆ†â€çš„å®Œæ•´äº¤äº’ï¼š
     - å…ˆå¼¹çª—é€‰å£°éƒ¨ï¼Œå†å¼€å§‹å½•éŸ³ï¼›å†æ¬¡ç‚¹å‡»ç»“æŸå¹¶æäº¤è¯„åˆ†
   - æ•°æ®æµï¼š
     - MediaRecorder å½•åˆ° scoreChunks
     - å¦‚æœ window.lamejs å¯ç”¨ï¼šéŸ³é¢‘ -> decode -> é‡é‡‡æ ·åˆ° 44100 -> MP3 ç¼–ç  -> base64 -> scoreAudioBase64()
     - å¦åˆ™ï¼šéŸ³é¢‘ -> decode -> é‡é‡‡æ ·åˆ° 44100 -> ç»„ WAV -> base64 -> scoreAudioBase64()

13) scoreAudioBase64(audioBase64, audioFormat)
   - èŒè´£ï¼šæ‰“å¼€è¯„åˆ†å¼¹çª—ã€showLoadingScoring()ã€è°ƒç”¨ sendAudioForScoring()ã€displayScoringResults()

E. TTSï¼ˆå¯é€‰ï¼šéœ€è¦â€œè¯­éŸ³æ’­æŠ¥â€æ—¶ï¼‰
14) connectTts()
   - èŒè´£ï¼šnew WebSocket(TTS_WS_URL)ï¼Œå¤„ç† response.audio.meta/url æˆ– delta
   - ä¾èµ–ï¼š
     - ttsFeedDelta(delta)ï¼šæŠŠæ¨¡å‹è¾“å‡ºæ–‡æœ¬åˆ†æ®µè¿½åŠ åˆ° buffer
     - ttsCommit()ï¼šå‘é€ commit è§¦å‘åç«¯åˆæˆ
     - playTtsUrl(url)ï¼šç”¨ <audio> æ’­æ”¾

15) closeTts()
   - èŒè´£ï¼šå…³é—­ wsï¼Œæ¸…ç†é˜Ÿåˆ—å’Œå®šæ—¶å™¨

ä¸‰ã€æ–°å‰ç«¯å¯¹é½çš„â€œæœ€å°è°ƒç”¨è·¯å¾„â€ï¼ˆæŒ‰ç”¨æˆ·æ“ä½œï¼‰
1) ç”¨æˆ·è¾“å…¥æ–‡å­—å¹¶å‘é€
   - UI -> sendMessage() -> /api/chat/stream -> SSE delta -> UI æ›´æ–°

2) ç”¨æˆ·ç‚¹ğŸ¤è¯­éŸ³è¾“å…¥å¹¶è‡ªåŠ¨å‘é€
   - toggleRecording() start/stop
   - onstop -> blobToPcm16kInt16ArrayBuffer() -> sendPcmToServer()
   - /api/voice/start -> è¿”å› text -> sendMessage()

3) ç”¨æˆ·é€‰æ–‡ä»¶è¯„åˆ†
   - startScoring() -> sendAudioForScoring() -> /api/audio/score -> displayScoringResults()

4) ç”¨æˆ·ç‚¹ğŸ¼å®æ—¶å½•éŸ³è¯„åˆ†
   - toggleScoreRecording() -> é€‰å£°éƒ¨å¼¹çª— -> beginScoreRecording()
   - stop -> MP3(WAV fallback) -> scoreAudioBase64() -> /api/audio/score -> displayScoringResults()

å››ã€å¯¹é½æ–°å‰ç«¯æ—¶å»ºè®®ä¿ç•™çš„â€œæ¥å£å¥‘çº¦â€
1) /api/voice/start è¾“å…¥ï¼šaudio_data(base64 PCM16k mono) + audio_format å›ºå®šå€¼
2) /api/audio/score è¾“å…¥ï¼šaudio_data(base64 å®¹å™¨å­—èŠ‚) + audio_format(æ‰©å±•å) + voice_type
3) /api/chat/stream è¾“å…¥ï¼šmessages[]ï¼ˆrole/contentï¼‰ï¼Œè¾“å‡º SSEï¼šdelta äº‹ä»¶
4) /ws/tts è¾“å…¥ï¼šappend/commitï¼Œè¾“å‡º meta.urlï¼ˆå³å¯æ’­æ”¾ï¼‰

äº”ã€æ¸…å•æ±‡æ€»ï¼ˆæŒ‰â€œå¯¹é½æ–°å‰ç«¯â€æœ€å°‘éœ€è¦å¤šå°‘ä¸ªå‡½æ•°ï¼‰
å¿…é¡»ï¼ˆä¸å« UI æ¡†æ¶/ç»„ä»¶ä»£ç ï¼‰ï¼š
1) sendMessage
2) extractSseEvents
3) addMessage
4) createStreamingBotMessage
5) initVoiceRecognition
6) toggleRecording
7) blobToPcm16kInt16ArrayBuffer
8) sendPcmToServer
9) startScoring
10) sendAudioForScoring
11) displayScoringResults
12) drawScoreChart
13) toggleScoreRecording
14) beginScoreRecording
15) confirmScoreVoiceAndStart
16) scoreAudioBase64
17) guessAudioFormatFromFile
18) pcm16ToWavArrayBuffer
19) arrayBufferToBase64

å¯é€‰ï¼ˆå¯ç”¨ TTS æ—¶ï¼‰ï¼š
20) connectTts
21) closeTts
22) ttsFeedDelta
23) ttsCommit
24) playTtsUrl

é™„ï¼šå‚è€ƒå®ç°ä½ç½®
- chat_interface.htmlï¼šoh-my-live2d-main (2)\\oh-my-live2d-main\\chat_interface.html
- asr_new.pyï¼šbackend/asr_new.py
- asr_server.pyï¼šbackend/asr_server.py
- qwen_chat_server.pyï¼šbackend/qwen_chat_server.py
- tts_ws_server.pyï¼šbackend/tts_ws_server.py
- mao_demo_server.pyï¼šmao_demo_server.py

