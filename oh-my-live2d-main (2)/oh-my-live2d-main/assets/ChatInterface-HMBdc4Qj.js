import{_ as H,d as k,h as M,e,g as D,i as se,v as pe,t as z,F as K,j as ee,n as Ce,k as re,l as U,r as x,m as ce,o as Ae,a as Ee,c as Re,w as ue,p as ze,u as Ue,b as Ve,f as O,q as $e,s as Ie}from"./index-DcibYH9B.js";import{B as Pe}from"./BackgroundImgLoad-YDsouuaq.js";function Y(d){const s=new Uint8Array(d);let o="";for(let t=0;t<s.length;t++)o+=String.fromCharCode(s[t]);return btoa(o)}function G(d,s,o){for(let t=0;t<o.length;t++)d.setUint8(s+t,o.charCodeAt(t))}function Ne(d,s=16e3,o=1){const t=new Uint8Array(d),l=t.byteLength,i=new ArrayBuffer(44+l),n=new DataView(i);return G(n,0,"RIFF"),n.setUint32(4,36+l,!0),G(n,8,"WAVE"),G(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,o,!0),n.setUint32(24,s,!0),n.setUint32(28,s*o*2,!0),n.setUint16(32,o*2,!0),n.setUint16(34,16,!0),G(n,36,"data"),n.setUint32(40,l,!0),new Uint8Array(i,44).set(t),i}async function qe(d){const s=await d.arrayBuffer(),o=window.AudioContext||window.webkitAudioContext,t=new o;let l=null;try{l=await t.decodeAudioData(s.slice(0))}catch{await new Promise(y=>setTimeout(y,50)),l=await t.decodeAudioData(s.slice(0))}finally{try{await t.close()}catch{}}const i=16e3,n=Math.round(l.duration*i),f=new OfflineAudioContext(1,n,i),r=f.createBufferSource();r.buffer=l,r.connect(f.destination),r.start(0);const v=(await f.startRendering()).getChannelData(0),B=new Int16Array(v.length);for(let S=0;S<v.length;S++){const y=Math.max(-1,Math.min(1,v[S]));B[S]=y<0?y*32768:y*32767}return B.buffer}async function de(d,s){const o=await d.arrayBuffer(),t=window.AudioContext||window.webkitAudioContext,l=new t;let i=null;try{i=await l.decodeAudioData(o.slice(0))}catch{await new Promise(y=>setTimeout(y,50)),i=await l.decodeAudioData(o.slice(0))}finally{try{await l.close()}catch{}}const n=Math.round(i.duration*s),f=new OfflineAudioContext(1,n,s),r=f.createBufferSource();r.buffer=i,r.connect(f.destination),r.start(0);const v=(await f.startRendering()).getChannelData(0),B=new Int16Array(v.length);for(let S=0;S<v.length;S++){const y=Math.max(-1,Math.min(1,v[S]));B[S]=y<0?y*32768:y*32767}return B.buffer}function Le(d){if(!d)return"wav";const s=d.name||"",o=s.lastIndexOf(".");let t=o>=0?s.slice(o+1).toLowerCase():"";return!t&&d.type&&(t=(d.type.split("/").pop()||"").toLowerCase()),t==="mpeg"&&(t="mp3"),(t==="x-wav"||t==="wave")&&(t="wav"),t||"wav"}function he(d){const s=[];let o;for(;(o=d.indexOf(`

`))!==-1;){const t=d.slice(0,o);d=d.slice(o+2);const l=t.split(`
`);for(const i of l)if(i.startsWith("data:")){const n=i.slice(5).trim();n&&s.push(n)}}return{events:s,rest:d}}const te={vibrato:"颤音技巧",throat:"喉位控制",position:"发声位置",open:"声道开放度",clean:"音色纯净度",resonate:"共鸣质量",unify:"声音统一性",falsetto:"假声技巧",chest:"胸声/真声",nasal:"鼻腔共鸣"};function Fe(d){const s=atob(d),o=new Uint8Array(s.length);for(let n=0;n<s.length;n++)o[n]=s.charCodeAt(n);const t=Math.floor(o.byteLength/2),l=new Int16Array(t),i=new DataView(o.buffer);for(let n=0;n<t;n++)l[n]=i.getInt16(n*2,!0);return l}class Oe{constructor(s=24e3){const o=window.AudioContext||window.webkitAudioContext;this.ctx=new o,this.inRate=s,this.outRate=this.ctx.sampleRate,this.queue=[],this.queuedSamples=0,this.minBufferSec=.1,this.startBufferSec=.12,this.nextTime=0}async ensureRunning(){this.ctx.state!=="running"&&await this.ctx.resume()}resetSchedule(){const s=this.ctx.currentTime;this.nextTime=s+this.startBufferSec,this.queue=[],this.queuedSamples=0}pushPcm16(s){if(!s||s.length===0)return;this.queue.push(s),this.queuedSamples+=s.length;const o=Math.floor(this.inRate*this.minBufferSec);if(this.queuedSamples>=o){const t=this._mergeQueue(),l=this._toFloatAndResampleIfNeeded(t);this._playFloat32(l)}}_mergeQueue(){const s=new Int16Array(this.queuedSamples);let o=0;for(const t of this.queue)s.set(t,o),o+=t.length;return this.queue=[],this.queuedSamples=0,s}_toFloatAndResampleIfNeeded(s){const o=new Float32Array(s.length);for(let n=0;n<s.length;n++)o[n]=s[n]/32768;if(this.inRate===this.outRate)return o;const t=this.outRate/this.inRate,l=Math.max(1,Math.floor(o.length*t)),i=new Float32Array(l);for(let n=0;n<l;n++){const f=n/t,r=Math.floor(f),T=Math.min(r+1,o.length-1),v=f-r;i[n]=o[r]*(1-v)+o[T]*v}return i}_playFloat32(s){const o=this.ctx.createBuffer(1,s.length,this.outRate);o.copyToChannel(s,0);const t=this.ctx.createBufferSource();t.buffer=o,t.connect(this.ctx.destination);const l=this.ctx.currentTime;this.nextTime<l+.02&&(this.nextTime=l+.02),t.start(this.nextTime),this.nextTime+=o.duration}}class De{constructor(){this.enabled=!1,this.socket=null,this.player=null,this.textBuf="",this.flushTimer=null,this.reconnectTimer=null,this.audioEl=null,this.urlQueue=[],this.urlPlaying=!1}getTtsUrl(){return`${location&&location.protocol==="https:"?"wss":"ws"}://${location.host}/ws/tts?voice=Cherry&model=qwen3-tts-flash&language_type=Chinese`}async connect(){this.socket&&(this.socket.readyState===WebSocket.OPEN||this.socket.readyState===WebSocket.CONNECTING)||(this.player=this.player||new Oe(24e3),await this.player.ensureRunning(),this.socket=new WebSocket(this.getTtsUrl()),this.socket.onopen=()=>{console.log("[TTS] ws open"),this.player&&this.player.resetSchedule()},this.socket.onerror=s=>{console.error("[TTS] ws error",s)},this.socket.onclose=()=>{console.log("[TTS] ws close"),this.scheduleReconnect()},this.socket.onmessage=s=>{let o;try{o=JSON.parse(s.data)}catch{return}if(console.log("[TTS] <-",o.type),o.type==="response.audio.delta"&&o.delta){try{const t=Fe(o.delta);this.player.pushPcm16(t)}catch(t){console.warn("[TTS] delta decode failed",t)}return}if(o.type==="response.audio.meta"&&o.meta&&o.meta.url){console.log("[TTS] meta url:",o.meta.url),this.playUrl(o.meta.url);return}o.type==="error"&&console.error("[TTS] error:",o.error)})}close(){try{if(this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null),this.socket&&this.socket.readyState===WebSocket.OPEN){try{this.socket.send(JSON.stringify({type:"session.finish"}))}catch{}this.socket.close()}}catch{}this.socket=null,this.textBuf="",this.urlQueue=[],this.urlPlaying=!1,this.audioEl&&(this.audioEl.pause(),this.audioEl=null)}scheduleReconnect(){this.enabled&&(this.reconnectTimer||(this.reconnectTimer=setTimeout(async()=>{this.reconnectTimer=null;try{await this.connect()}catch{}},600)))}playUrl(s){s&&(this.audioEl||(this.audioEl=new Audio,this.audioEl.preload="auto",this.audioEl.onended=()=>this.playNextUrl(),this.audioEl.onerror=()=>this.playNextUrl()),this.urlQueue.push(s),this.urlPlaying||this.playNextUrl())}playNextUrl(){if(!this.audioEl)return;const s=this.urlQueue.shift();if(!s){this.urlPlaying=!1;return}this.urlPlaying=!0,this.audioEl.src=s,this.audioEl.play().catch(o=>{console.warn("[TTS] audio play blocked:",o),setTimeout(()=>this.playNextUrl(),150)})}appendText(s){this.enabled&&(!this.socket||this.socket.readyState!==WebSocket.OPEN||!s||!s.trim()||this.socket.send(JSON.stringify({type:"input_text_buffer.append",text:s})))}commit(){this.enabled&&(!this.socket||this.socket.readyState!==WebSocket.OPEN||this.socket.send(JSON.stringify({type:"input_text_buffer.commit"})))}startFlushTimer(){this.flushTimer||(this.flushTimer=setInterval(()=>{this.enabled&&this.textBuf&&(this.appendText(this.textBuf),this.textBuf="")},450))}feedDelta(s){if(!this.enabled||!s)return;this.textBuf+=s,(/[。！？!?；;，,\n]/.test(this.textBuf)||this.textBuf.length>=24)&&(this.appendText(this.textBuf),this.textBuf="")}setEnabled(s){this.enabled=s}clearBuffer(){this.textBuf="",this.urlQueue=[],this.urlPlaying=!1,this.audioEl&&this.audioEl.pause()}}const He={class:"audio-scoring-section"},je={class:"scoring-controls"},We={class:"voice-selection"},Je={class:"file-upload"},Qe={for:"audioFile",class:"file-label"},Ge=["disabled"],Ke={key:0,class:"scoring-results"},Ye={key:0,class:"loading"},Xe={class:"results-container"},Ze={class:"overall-score"},et={class:"score-value"},tt={class:"technique-scores"},st={class:"technique"},ot={class:"technique-name"},at={class:"technique-score"},nt={class:"chart-container"},it={class:"chart-bars"},lt={class:"chart-bar-value"},rt=["title"],ct={__name:"AudioScoringModal",props:{show:{type:Boolean,default:!1}},emits:["update:show","score"],setup(d,{expose:s,emit:o}){const t=o,l=x("女高音 Soprano"),i=x(null),n=x(""),f=x(null),r=x(!1),T=x(!1),v=x(null),B=b=>te[b]||b,S=b=>{b.target.classList.contains("audio-scoring-modal")&&y()},y=()=>{t("update:show",!1),i.value=null,n.value="",T.value=!1,v.value=null,r.value=!1,f.value&&(f.value.value="")},I=b=>{const c=b.target.files[0];c&&(i.value=c,n.value=c.name)},N=async()=>{if(!i.value){alert("请先选择一个音频文件");return}r.value=!0,T.value=!0,v.value=null;try{const b=await i.value.arrayBuffer(),c=Y(b),m=Le(i.value);t("score",{audioData:c,voiceType:l.value,audioFormat:m})}catch(b){console.error("音频处理失败:",b),alert("音频处理失败: "+b.message),r.value=!1,T.value=!1}};return s({updateResult:b=>{v.value=b,r.value=!1}}),(b,c)=>(k(),M("div",{class:U(["audio-scoring-modal",{active:d.show}]),onClick:S},[e("div",He,[e("div",{class:"scoring-header"},[c[2]||(c[2]=e("div",null,[e("h3",null,[e("svg",{class:"icon icon-small",viewBox:"0 0 24 24"},[e("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 2.34 9 5v6c0 1.66 1.34 3 3 3z"}),e("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"})]),D(" 音频评分功能 ")]),e("p",{class:"header-subtitle"},"上传音频文件进行演唱技巧评分")],-1)),e("button",{class:"close-modal",title:"关闭",onClick:y},[...c[1]||(c[1]=[e("svg",{class:"icon",viewBox:"0 0 24 24"},[e("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})],-1)])])]),e("div",je,[e("div",We,[c[4]||(c[4]=e("label",{for:"voiceType"},"选择声部:",-1)),se(e("select",{id:"voiceType","onUpdate:modelValue":c[0]||(c[0]=m=>l.value=m),class:"voice-select"},[...c[3]||(c[3]=[e("option",{value:"女高音 Soprano"},"女高音 Soprano",-1),e("option",{value:"女中音 Mezzo"},"女中音 Mezzo",-1),e("option",{value:"男高音 Tenor"},"男高音 Tenor",-1),e("option",{value:"男中音 Baritone"},"男中音 Baritone",-1)])],512),[[pe,l.value]])]),e("div",Je,[e("input",{type:"file",id:"audioFile",ref_key:"audioFileInput",ref:f,accept:"audio/*",class:"file-input",onChange:I},null,544),e("label",Qe,[c[5]||(c[5]=e("svg",{class:"icon",viewBox:"0 0 24 24"},[e("path",{d:"M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"})],-1)),D(" "+z(n.value||"选择音频文件"),1)])]),e("button",{class:"score-button",onClick:N,disabled:!i.value||r.value},z(r.value?"评分中...":"开始评分"),9,Ge)]),T.value?(k(),M("div",Ke,[r.value?(k(),M("div",Ye,[...c[6]||(c[6]=[e("p",null,"正在分析音频...",-1),e("p",null,"请稍候...",-1)])])):v.value?(k(),M(K,{key:1},[c[10]||(c[10]=e("h4",null,"评分结果",-1)),e("div",Xe,[e("div",Ze,[c[7]||(c[7]=e("span",{class:"score-label"},"总体均分:",-1)),e("span",et,z(Number(v.value.overall).toFixed(1)),1)]),e("div",tt,[e("div",st,[(k(!0),M(K,null,ee(v.value.scores,m=>(k(),M("div",{key:m.technique,class:"technique-item"},[e("span",ot,z(B(m.technique)),1),e("span",at,z(m.score)+"/5",1)]))),128))])]),e("div",nt,[c[8]||(c[8]=e("div",{class:"chart-title"},"演唱技巧评分详情",-1)),e("div",it,[(k(!0),M(K,null,ee(v.value.scores,m=>(k(),M("div",{key:m.technique,class:"chart-bar-item"},[e("span",lt,z(m.score),1),e("div",{class:"chart-bar",style:Ce({height:m.score/5*160+"px"})},null,4),e("span",{class:"chart-bar-label",title:B(m.technique)},z(B(m.technique)),9,rt)]))),128))]),c[9]||(c[9]=e("div",{class:"chart-y-axis"},[e("span",null,"5"),e("span",null,"4"),e("span",null,"3"),e("span",null,"2"),e("span",null,"1"),e("span",null,"0")],-1))])])],64)):re("",!0)])):re("",!0)])],2))}},ut=H(ct,[["__scopeId","data-v-c222520a"]]),dt={class:"audio-scoring-section"},ht={class:"scoring-controls"},ft={class:"voice-selection"},pt={__name:"ScoreVoiceModal",props:{show:{type:Boolean,default:!1}},emits:["update:show","confirm"],setup(d,{emit:s}){const o=s,t=x("女高音 Soprano"),l=f=>{f.target.classList.contains("audio-scoring-modal")&&i()},i=()=>{o("update:show",!1)},n=()=>{o("confirm",t.value),i()};return(f,r)=>(k(),M("div",{class:U(["audio-scoring-modal",{active:d.show}]),onClick:l},[e("div",dt,[e("div",{class:"scoring-header"},[r[2]||(r[2]=e("div",null,[e("h3",null,[e("svg",{class:"icon icon-small",viewBox:"0 0 24 24"},[e("path",{d:"M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"})]),D(" 录音并评分 ")]),e("p",{class:"header-subtitle"},"请选择声部后开始录音评分")],-1)),e("button",{class:"close-modal",title:"关闭",onClick:i},[...r[1]||(r[1]=[e("svg",{class:"icon",viewBox:"0 0 24 24"},[e("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})],-1)])])]),e("div",ht,[e("div",ft,[r[4]||(r[4]=e("label",{for:"scoreVoiceType"},"选择声部:",-1)),se(e("select",{id:"scoreVoiceType","onUpdate:modelValue":r[0]||(r[0]=T=>t.value=T),class:"voice-select"},[...r[3]||(r[3]=[e("option",{value:"女高音 Soprano"},"女高音 Soprano",-1),e("option",{value:"女中音 Mezzo"},"女中音 Mezzo",-1),e("option",{value:"男高音 Tenor"},"男高音 Tenor",-1),e("option",{value:"男中音 Baritone"},"男中音 Baritone",-1)])],512),[[pe,t.value]])]),e("button",{class:"score-button",onClick:n},"开始录音评分"),e("button",{class:"score-button secondary",onClick:i},"取消")])])],2))}},vt=H(pt,[["__scopeId","data-v-6c3ed85d"]]),mt={__name:"MicPermissionModal",props:{show:{type:Boolean,default:!1}},emits:["update:show","request"],setup(d,{emit:s}){const o=s,t=n=>{n.target.classList.contains("audio-scoring-modal")&&l()},l=()=>{o("update:show",!1)},i=()=>{o("request")};return(n,f)=>(k(),M("div",{class:U(["audio-scoring-modal",{active:d.show}]),onClick:t},[e("div",{class:"audio-scoring-section"},[e("div",{class:"scoring-header"},[f[1]||(f[1]=e("div",null,[e("h3",null,[e("svg",{class:"icon icon-small",viewBox:"0 0 24 24"},[e("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 2.34 9 5v6c0 1.66 1.34 3 3 3z"}),e("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"})]),D(" 需要麦克风权限 ")]),e("p",{class:"header-subtitle"},"请允许浏览器访问麦克风，用于语音识别与评分录音")],-1)),e("button",{class:"close-modal",title:"关闭",onClick:l},[...f[0]||(f[0]=[e("svg",{class:"icon",viewBox:"0 0 24 24"},[e("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})],-1)])])]),e("div",{class:"scoring-controls"},[e("button",{class:"score-button",onClick:i},"重新申请权限"),e("button",{class:"score-button secondary",onClick:l},"稍后再说")])])],2))}},gt=H(mt,[["__scopeId","data-v-3aacec88"]]),yt={class:"audio-scoring-section"},wt={class:"scoring-header"},bt={class:"header-subtitle"},xt={__name:"RecordingStatusModal",props:{show:{type:Boolean,default:!1},recordingType:{type:String,default:null}},emits:["update:show","stop"],setup(d,{emit:s}){const o=d,t=s,l=ce(()=>o.recordingType==="score"?"评分录音进行中":"语音录音进行中"),i=ce(()=>o.recordingType==="score"?"演唱片段将用于评分，点击结束后自动处理":"语音识别正在录音，再次点击或按停止即可结束"),n=r=>{r.target.classList.contains("audio-scoring-modal")&&f()},f=()=>{t("stop"),t("update:show",!1)};return(r,T)=>(k(),M("div",{class:U(["audio-scoring-modal",{active:d.show}]),onClick:n},[e("div",yt,[e("div",wt,[e("div",null,[e("h3",null,[T[0]||(T[0]=e("svg",{class:"icon icon-small",viewBox:"0 0 24 24"},[e("path",{d:"M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"})],-1)),D(" "+z(l.value),1)]),e("p",bt,z(i.value),1)]),e("button",{class:"close-modal",title:"停止录音",onClick:f},[...T[1]||(T[1]=[e("svg",{class:"icon",viewBox:"0 0 24 24"},[e("path",{d:"M6 6h12v12H6z"})],-1)])])]),e("div",{class:"scoring-controls"},[e("button",{class:"score-button",onClick:f},"结束并处理")])])],2))}},Tt=H(xt,[["__scopeId","data-v-7a3136d3"]]),St={class:"container"},kt={class:"chat-section"},Mt={class:"chat-header"},Bt={class:"chat-input-area"},_t={class:"tools-content"},Ct={key:0,class:"icon",viewBox:"0 0 24 24"},At={key:1,class:"icon",viewBox:"0 0 24 24"},Et={key:0,class:"icon",viewBox:"0 0 24 24"},Rt={key:1,class:"icon",viewBox:"0 0 24 24"},zt={class:"input-group"},Ut={key:0,class:"icon",viewBox:"0 0 24 24"},Vt={key:1,class:"icon",viewBox:"0 0 24 24"},$t="",It="",fe="",Pt='你是"滴哇老师"，一位专业、耐心、严格但友好的美声声乐老师。你擅长给出可执行的练习建议（呼吸、支点、共鸣、咬字、连贯、元音统一、音区过渡等），回答要结构清晰、步骤明确、避免空话。在输出时，应当保持一位老师的严谨，避免用太多的语气词，每次回答控制在100个汉字之内',Nt={__name:"ChatInterface",setup(d){const s=Ue(),o=x(null),t=x([{sender:"bot",text:"你好！我是你的声乐老师滴哇，很高兴为你服务！有什么声乐方面的问题都可以问我哦~"}]),l=x(""),i=x(""),n=x(!1),f=x([{role:"system",content:Pt},{role:"assistant",content:"你好！我是你的声乐老师滴哇，很高兴为你服务！有什么声乐方面的问题都可以问我哦~"}]),r=x(!1),T=x(!1);let v=null,B=null,S=[],y=null,I=[],N="",j="mp3";const b=x(null),c=x(!1),m=new De,W=x(!1),X=x(!1),J=x(!1),P=x(!1),oe=x("女高音 Soprano"),ve=()=>{s.push("/")},me=()=>{n.value=!n.value},q=()=>{ze(()=>{o.value&&(o.value.scrollTop=o.value.scrollHeight)})},ae=(u,a)=>(t.value.push({text:u,sender:a}),q(),t.value[t.value.length-1]),ne=async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){i.value="浏览器不支持录音功能";return}const u=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!0}});B=u;const a={};MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?a.mimeType="audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/webm")&&(a.mimeType="audio/webm"),v=new MediaRecorder(u,a),v.ondataavailable=h=>{h.data&&h.data.size>0&&S.push(h.data)},v.onstop=async()=>{try{if(S.length===0){i.value="录音数据为空，请重试";return}i.value="正在转换音频格式(PCM16k)...";const h=new Blob(S,{type:v.mimeType});S=[];const p=await qe(h),g=Y(p);await ye(g)}catch(h){console.error("录音停止处理失败:",h),i.value="音频处理失败: "+h.message}},i.value=""}catch(u){console.error("语音识别初始化失败:",u),i.value="麦克风权限获取失败: "+u.message,J.value=!0}},ge=()=>{if(!v){i.value="语音识别未初始化";return}if(T.value){alert("正在进行评分录音，请先结束");return}r.value?(v.stop(),r.value=!1,i.value="识别中...",P.value=!1,b.value=null):(S=[],v.start(),r.value=!0,i.value="录音中... 点击停止",b.value="asr",P.value=!0)},ye=async u=>{try{i.value="识别中...";const a=new AbortController,h=setTimeout(()=>a.abort(),3e4),p=await fetch(`${It}/api/voice/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_data:u,audio_format:"pcm16le_16k_mono"}),signal:a.signal});clearTimeout(h);const g=await p.json().catch(()=>({}));if(!p.ok){console.error("语音识别服务错误:",g),i.value="语音识别服务错误: "+(g.error||p.status);return}const w=(g.text||"").trim();if(!w){i.value="未识别到文本";return}l.value=w,i.value="识别完成，已发送",await Z()}catch(a){console.error("发送音频失败:",a),i.value=a.name==="AbortError"?"识别请求超时":"发送音频失败: "+a.message}},Z=async()=>{const u=l.value.trim();if(!u)return;ae(u,"user"),l.value="",f.value.push({role:"user",content:u});const a=t.value.length;t.value.push({text:"",sender:"bot"}),q();const h=new AbortController,p=setTimeout(()=>h.abort(),12e4);if(c.value){m.clearBuffer();try{await m.connect(),m.startFlushTimer()}catch{}}try{const g=await fetch(`${fe}/api/chat/stream`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"qwen-plus",messages:f.value}),signal:h.signal});if(!g.ok||!g.body){const C=await g.text().catch(()=>"");t.value[a].text=`请求失败：HTTP ${g.status}
${C}`;return}const w=g.body.getReader(),R=new TextDecoder("utf-8");let _="",E="";for(;;){const{value:C,done:Q}=await w.read();if(Q)break;_+=R.decode(C,{stream:!0});const{events:L,rest:V}=he(_);_=V;for(const F of L){let A=null;try{A=JSON.parse(F)}catch{}A&&(A.type==="delta"&&A.delta?(E+=A.delta,t.value[a].text=E,q(),c.value&&m.feedDelta(A.delta)):A.type==="error"&&(t.value[a].text=`模型调用错误：${A.error}`))}}if(E.trim())f.value.push({role:"assistant",content:E});else{const C="我这次没有生成出有效回复。你可以换一种说法再问一次。";t.value[a].text=C,f.value.push({role:"assistant",content:C})}c.value&&(m.textBuf.trim()&&(m.appendText(m.textBuf),m.textBuf=""),m.commit())}catch(g){t.value[a].text=g.name==="AbortError"?"请求超时：后端在 120 秒内未完成响应。":"请求异常："+g.message}finally{clearTimeout(p),h.abort()}},we=async()=>{if(c.value=!c.value,m.setEnabled(c.value),c.value)try{await m.connect(),m.startFlushTimer()}catch(u){console.error(u)}else m.close()},be=()=>{if(!B){i.value="语音识别未初始化";return}if(r.value){alert("正在进行语音输入录音，请先结束");return}T.value?(y&&y.state!=="inactive"&&y.stop(),P.value=!1,b.value=null):X.value=!0},xe=u=>{oe.value=u,Te()},Te=()=>{if(!B)return;const u={};let a="";MediaRecorder.isTypeSupported("audio/mpeg")?a="audio/mpeg":MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?a="audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/webm")?a="audio/webm":MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")&&(a="audio/ogg;codecs=opus"),a&&(u.mimeType=a),y=new MediaRecorder(B,u),I=[],y.ondataavailable=h=>{h.data&&h.data.size>0&&I.push(h.data)},y.onstop=async()=>{try{if(!I.length){i.value="录音数据为空，请重试";return}i.value="评分中...";const h=new Blob(I,{type:y.mimeType});if(I=[],window.lamejs&&window.lamejs.Mp3Encoder){const g=await de(h,44100),w=new Int16Array(g),R=new window.lamejs.Mp3Encoder(1,44100,128),_=[],E=1152;for(let V=0;V<w.length;V+=E){const F=w.subarray(V,V+E),A=R.encodeBuffer(F);A&&A.length&&_.push(new Uint8Array(A))}const C=R.flush();C&&C.length&&_.push(new Uint8Array(C));const L=await new Blob(_,{type:"audio/mpeg"}).arrayBuffer();N=Y(L),j="mp3"}else{const g=await de(h,44100),w=Ne(g,44100,1);N=Y(w),j="wav"}await Se(N,j)}catch(h){console.error(h),alert("音频评分失败: "+h.message)}finally{T.value=!1,P.value=!1,b.value=null}},y.start(),T.value=!0,i.value="评分录音中... 再点一次结束",b.value="score",P.value=!0},Se=async(u,a)=>{W.value=!0,await ie({audioData:u,voiceType:oe.value,audioFormat:a})},ke=()=>{W.value=!0},ie=async({audioData:u,voiceType:a,audioFormat:h})=>{try{const p=await fetch(`${$t}/api/audio/score`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio_data:u,voice_type:a,audio_format:h})});if(!p.ok){const _=await p.json();throw new Error(_.detail||"音频评分失败")}const g=await p.json();if(!g.success)throw new Error(g.message||"音频评分失败");const w={overall:g.overall,scores:g.scores};let R=`音频评分结果
总体评分: ${Number(w.overall).toFixed(1)}

`;R+=`各项评分：
`,w.scores.forEach(_=>{const E=te[_.technique]||_.technique;R+=`• ${E}: ${_.score}分
`}),ae(R,"bot"),await Me(w)}catch(p){console.error("音频评分失败:",p),alert("音频评分失败: "+p.message)}},Me=async u=>{let a=`我刚刚完成了一次音频评分，总体评分是${Number(u.overall).toFixed(1)}分。

`;a+=`各项评分详情：
`,u.scores.forEach(w=>{const R=te[w.technique]||w.technique;a+=`• ${R}: ${w.score}分
`}),a+=`
根据我的评分，请给出具体的改进建议，帮助我提升发音和表达水平。1分是最高分，5分是最低分`;const h=t.value.length;t.value.push({text:"正在根据评分生成建议...",sender:"bot"}),q();const p=new AbortController,g=setTimeout(()=>p.abort(),6e4);try{const w=await fetch(`${fe}/api/chat/stream`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"qwen-plus",messages:[{role:"user",content:a}]}),signal:p.signal});if(!w.ok||!w.body){t.value[h].text="生成建议失败";return}const R=w.body.getReader(),_=new TextDecoder("utf-8");let E="",C="";for(;;){const{value:Q,done:L}=await R.read();if(L)break;E+=_.decode(Q,{stream:!0});const{events:V,rest:F}=he(E);E=F;for(const A of V){let $=null;try{$=JSON.parse(A)}catch{}$&&($.type==="delta"&&$.delta?(C+=$.delta,t.value[h].text=C,q()):$.type==="error"&&(t.value[h].text=`生成建议错误：${$.error}`))}}C.trim()?f.value.push({role:"assistant",content:C}):t.value[h].text="抱歉，我这次没有生成出有效建议。"}catch(w){t.value[h].text=w.name==="AbortError"?"生成建议超时，请稍后重试。":"生成建议失败："+w.message}finally{clearTimeout(g),p.abort()}},Be=async()=>{await ne(),J.value=!1},_e=()=>{b.value==="asr"?v&&v.state!=="inactive"&&v.stop():b.value==="score"&&y&&y.state!=="inactive"&&y.stop()},le=()=>{try{const u=window.OML2D||window.Oml2d;u&&u.loadOml2d({importType:"cubism5",models:[{path:"/mao/mao_pro.model3.json",scale:.07,position:[0,0],showHitAreaFrames:!1,motionPreloadStrategy:"ALL"}],parentElement:document.getElementById("oml2d-container"),primaryColor:"#0B57D0",sayHello:!1,tips:{welcomeTips:{duration:0,priority:0},idleTips:{duration:0,priority:0}}})}catch(u){console.warn("Live2D 初始化失败（可忽略）:",u)}};return Ae(async()=>{await ne(),window.OML2D||window.Oml2d?le():setTimeout(le,100),document.addEventListener("click",u=>{const a=document.getElementById("toolsGroup");a&&n.value&&!a.contains(u.target)&&(n.value=!1)})}),Ee(()=>{B&&B.getTracks().forEach(u=>u.stop()),m.close()}),(u,a)=>{const h=Ve("router-link");return k(),Re(Pe,{imgUrl:"/background.webp",width:"100%",height:"100%",showDecorations:!0,theme:"cute"},{default:ue(()=>[e("div",St,[e("div",{class:"character-section"},[a[5]||(a[5]=e("h2",{class:"character-title"},"滴哇老师",-1)),e("div",{id:"oml2d-container",onClick:ve,title:"点击角色区域返回主页"}),a[6]||(a[6]=e("div",{class:"character-info"},[e("p",null,"我是你的声乐老师滴哇"),e("p",null,"随时为你提供声乐指导"),e("p",null,"点击我可以回到主页哦~")],-1))]),e("div",kt,[e("div",Mt,[O(h,{to:"/",class:"back-link-btn",title:"返回主页"},{default:ue(()=>[...a[7]||(a[7]=[e("svg",{class:"icon",viewBox:"0 0 24 24"},[e("path",{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"})],-1)])]),_:1}),a[8]||(a[8]=e("div",{class:"chat-title"},"与滴哇老师对话",-1)),a[9]||(a[9]=e("div",{class:"chat-subtitle"},"随时为你提供专业的声乐指导",-1))]),e("div",{class:"chat-messages",ref_key:"chatMessages",ref:o},[(k(!0),M(K,null,ee(t.value,(p,g)=>(k(),M("div",{key:g,class:U(["message",`message-${p.sender}`])},z(p.text),3))),128))],512),e("div",Bt,[e("div",{class:U(["tools-group",{expanded:n.value}]),id:"toolsGroup"},[e("button",{class:"tool-button mobile-toggle",onClick:me,title:"展开工具"},[...a[10]||(a[10]=[e("svg",{class:"icon",viewBox:"0 0 24 24"},[e("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"})],-1)])]),e("div",_t,[e("button",{class:U(["tool-button",{active:c.value}]),onClick:we,title:"语音播报开关"},[c.value?(k(),M("svg",Ct,[...a[11]||(a[11]=[e("path",{d:"M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"},null,-1)])])):(k(),M("svg",At,[...a[12]||(a[12]=[e("path",{d:"M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"},null,-1)])]))],2),e("button",{class:"tool-button",onClick:be,title:"录音并评分"},[T.value?(k(),M("svg",Rt,[...a[14]||(a[14]=[e("path",{d:"M6 6h12v12H6z"},null,-1)])])):(k(),M("svg",Et,[...a[13]||(a[13]=[e("path",{d:"M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"},null,-1)])]))]),e("button",{class:"tool-button",onClick:ke,title:"音频评分"},[...a[15]||(a[15]=[e("svg",{class:"icon",viewBox:"0 0 24 24"},[e("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"})],-1)])])])],2),e("div",zt,[e("button",{class:U(["voice-button",{listening:r.value}]),onClick:ge,title:"语音输入"},[r.value?(k(),M("svg",Vt,[...a[17]||(a[17]=[e("path",{d:"M6 6h12v12H6z"},null,-1)])])):(k(),M("svg",Ut,[...a[16]||(a[16]=[e("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 2.34 9 5v6c0 1.66 1.34 3 3 3z"},null,-1),e("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"},null,-1)])]))],2),se(e("input",{type:"text",class:"chat-input","onUpdate:modelValue":a[0]||(a[0]=p=>l.value=p),placeholder:"输入你想说的话...",onKeypress:$e(Z,["enter"])},null,544),[[Ie,l.value]]),e("button",{class:"send-button",onClick:Z},"发送")]),e("div",{class:U(["voice-status",{show:i.value}])},z(i.value),3)])]),O(ut,{show:W.value,"onUpdate:show":a[1]||(a[1]=p=>W.value=p),onScore:ie},null,8,["show"]),O(vt,{show:X.value,"onUpdate:show":a[2]||(a[2]=p=>X.value=p),onConfirm:xe},null,8,["show"]),O(gt,{show:J.value,"onUpdate:show":a[3]||(a[3]=p=>J.value=p),onRequest:Be},null,8,["show"]),O(Tt,{show:P.value,"onUpdate:show":a[4]||(a[4]=p=>P.value=p),"recording-type":b.value,onStop:_e},null,8,["show","recording-type"])])]),_:1})}}},Ot=H(Nt,[["__scopeId","data-v-f88e698a"]]);export{Ot as default};
